hahayq
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Up Mobile Legends: Bang Bang - GamesNow</title>
    <link rel="icon" href="https://reygenteng.github.io/gamesku/gamesnow.png" type="image/png">
    <style>
        /* CSS yang sudah ada tetap sama, tambahkan ini untuk modal konfirmasi */
        
        #confirmModal {
            display: none;
            position: fixed;
            z-index: 102;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }

        #confirmModal .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .confirm-details {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #ff4500;
        }

        .confirm-detail-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .confirm-detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: normal;
        }

        .detail-value {
            font-weight: bold;
            color: #333;
        }

        .username-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .username-valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .username-invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn-confirm-payment {
            background-color: #ff4500;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }

        .btn-confirm-payment:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff4500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Modal Konfirmasi Baru -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeConfirmModal">&times;</span>
            <div class="modal-body">
                <h4>Konfirmasi Pembelian</h4>
                <p>Pastikan data berikut sudah benar:</p>
                
                <div class="confirm-details">
                    <div class="confirm-detail-item">
                        <span class="detail-label">Diamond:</span>
                        <span class="detail-value" id="confirmDiamonds">-</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Harga:</span>
                        <span class="detail-value">Rp <span id="confirmPrice">0</span></span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Pembayaran:</span>
                        <span class="detail-value" id="confirmPayment">-</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">User ID:</span>
                        <span class="detail-value" id="confirmUserId">-</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Zone ID:</span>
                        <span class="detail-value" id="confirmZoneId">-</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Username:</span>
                        <span class="detail-value" id="confirmUsername">Memeriksa...</span>
                    </div>
                </div>

                <div id="usernameStatus" class="username-status">
                    <span class="loading-spinner"></span>
                    <span id="statusText">Memeriksa username...</span>
                </div>

                <button id="confirmPaymentButton" class="btn-confirm-payment" disabled>
                    Lanjutkan Pembayaran QRIS
                </button>
            </div>
        </div>
    </div>

    <!-- Kode HTML yang sudah ada tetap di sini -->
    <header>
        <!-- ... existing header code ... -->
    </header>

    <div class="breadcrumbs">
        <a href="index.html">Home</a> / Top Up Mobile Legends: Bang Bang
    </div>

    <div class="game-info">
        <img src="https://reygenteng.github.io/gamesku/ml.png" alt="Mobile Legends Logo">
        <div>
            <p>TOP UP</p>
            <h2>Top Up MLBB (Mobile Legends)</h2>
            <p style="color:#888; font-size:0.8em;">Lihat cara transaksi</p>
        </div>
    </div>

    <!-- ... rest of your existing HTML code ... -->

    <script>
        // --- Variabel Global Tambahan ---
        let currentUsername = '';
        let isUsernameValid = false;

        // --- Ambil Elemen Modal Konfirmasi ---
        const confirmModal = document.getElementById('confirmModal');
        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
        const usernameStatus = document.getElementById('usernameStatus');
        const statusText = document.getElementById('statusText');

        // --- Fungsi untuk Menampilkan Modal Konfirmasi ---
        function showConfirmModal() {
            // Isi data di modal konfirmasi
            document.getElementById('confirmDiamonds').textContent = selectedNominal.dataset.diamonds;
            document.getElementById('confirmPrice').textContent = parseInt(selectedNominal.dataset.price).toLocaleString('id-ID');
            document.getElementById('confirmPayment').textContent = selectedPayment.dataset.name;
            document.getElementById('confirmUserId').textContent = userIdInput.value;
            document.getElementById('confirmZoneId').textContent = zoneIdInput.value;
            document.getElementById('confirmUsername').textContent = 'Memeriksa...';

            // Reset status
            usernameStatus.className = 'username-status';
            usernameStatus.innerHTML = '<span class="loading-spinner"></span><span id="statusText">Memeriksa username...</span>';
            confirmPaymentButton.disabled = true;
            isUsernameValid = false;

            // Tampilkan modal
            confirmModal.style.display = 'block';

            // Cek username
            checkUsername();
        }

        // --- Fungsi untuk Mengecek Username ---
        async function checkUsername() {
            const userId = userIdInput.value;
            const zoneId = zoneIdInput.value;

            if (!userId || !zoneId) {
                showUsernameStatus(false, 'User ID dan Zone ID harus diisi');
                return;
            }

            try {
                // Ganti YOUR_DOMAIN dengan domain Vercel Anda
                // Contoh: https://your-app.vercel.app/api/ml
                const response = await fetch(`/api/ml?id=${userId}&server=${zoneId}`);
                const data = await response.json();

                if (data.success && data.data && data.data.username) {
                    currentUsername = data.data.username;
                    document.getElementById('confirmUsername').textContent = currentUsername;
                    showUsernameStatus(true, `Username valid: ${currentUsername}`);
                } else {
                    showUsernameStatus(false, 'Username tidak ditemukan. Pastikan User ID dan Zone ID benar.');
                }
            } catch (error) {
                console.error('Error checking username:', error);
                showUsernameStatus(false, 'Gagal memeriksa username. Coba lagi.');
            }
        }

        // --- Fungsi untuk Menampilkan Status Username ---
        function showUsernameStatus(isValid, message) {
            statusText.textContent = message;
            
            if (isValid) {
                usernameStatus.className = 'username-status username-valid';
                usernameStatus.innerHTML = `✓ ${message}`;
                confirmPaymentButton.disabled = false;
                isUsernameValid = true;
            } else {
                usernameStatus.className = 'username-status username-invalid';
                usernameStatus.innerHTML = `✗ ${message}`;
                confirmPaymentButton.disabled = true;
                isUsernameValid = false;
            }
        }

        // --- Modifikasi Fungsi handleQrisPayment ---
        function handleQrisPayment() {
            // Tampilkan modal konfirmasi dulu, bukan langsung proses QRIS
            showConfirmModal();
        }

        // --- Event Listener untuk Tombol Konfirmasi Pembayaran ---
        confirmPaymentButton.addEventListener('click', function() {
            if (isUsernameValid) {
                confirmModal.style.display = 'none';
                // Lanjutkan dengan proses QRIS yang sudah ada
                processQrisPayment();
            }
        });

        // --- Fungsi Process QRIS (dipisah dari handleQrisPayment) ---
        async function processQrisPayment() {
            beliButton.textContent = 'Memproses...';
            beliButton.disabled = true;

            const nominal = parseInt(selectedNominal.dataset.price);
            const reff_id = `GN-ML-${Date.now()}`; 
            const data = {
                reff_id: reff_id,
                nominal: nominal,
                type: 'ewallet',
                metode: 'qrisfast'
            };

            const response = await callApi('/deposit/create', data);

            if (response.status === true) {
                const depositData = response.data;
                currentDepositId = depositData.id;

                const newUrl = window.location.pathname + '?idpayment=' + depositData.id;
                history.pushState({ path: newUrl }, '', newUrl);

                document.getElementById('qrisImage').src = depositData.qr_image;
                document.getElementById('qrisNominal').textContent = depositData.nominal.toLocaleString('id-ID');
                document.getElementById('qrisStatus').textContent = 'Silakan scan QR untuk membayar...';
                qrisModal.style.display = 'block';

                const userId = userIdInput.value;
                const zoneId = zoneIdInput.value;
                const target = `${userId}|${zoneId}`; 
                
                const orderDetails = {
                    depositId: depositData.id,
                    productCode: selectedNominal.dataset.code,
                    productName: selectedNominal.dataset.diamonds,
                    userId: userId, 
                    zoneId: zoneId, 
                    target: target,
                    price: depositData.nominal,
                    username: currentUsername // Simpan username untuk receipt
                };

                const expiryTime = new Date(depositData.expired_at).getTime();
                startQrisTimer(expiryTime, depositData.id);
                startPollingDepositStatus(orderDetails);

            } else {
                alert('Gagal membuat QRIS: ' + (response.message || 'Error tidak diketahui'));
                beliButton.textContent = 'Beli Sekarang';
                beliButton.disabled = false;
            }
        }

        // --- Event Listener untuk Menutup Modal Konfirmasi ---
        closeConfirmModal.addEventListener('click', function() {
            confirmModal.style.display = 'none';
            // Enable tombol beli kembali
            beliButton.textContent = 'Beli Sekarang';
            beliButton.disabled = false;
        });

        // --- Modifikasi Fungsi showReceipt untuk menampilkan username ---
        async function handleTopUp(orderDetails) {
            const trxReffId = `GN-TOPUP-${Date.now()}`;
            
            const data = {
                reff_id: trxReffId,
                code: orderDetails.productCode,
                target: orderDetails.target
            };

            const response = await callApi('/transaksi/create', data);

            qrisModal.style.display = 'none';

            const combinedId = `${orderDetails.userId}|${orderDetails.zoneId}`;
            
            document.getElementById('receiptProduct').textContent = orderDetails.productName;
            document.getElementById('receiptUserId').textContent = combinedId;
            document.getElementById('receiptPrice').textContent = orderDetails.price.toLocaleString('id-ID');
            document.getElementById('receiptPayment').textContent = 'QRIS';

            // Tampilkan username di receipt
            document.getElementById('receiptUsername').textContent = orderDetails.username;

            if (response.status === true) {
                document.getElementById('receiptTitle').textContent = 'Transaksi Diproses';
                document.getElementById('receiptStatus').textContent = response.data.status;
                document.getElementById('receiptTrxId').textContent = response.data.id;
            } else {
                document.getElementById('receiptTitle').textContent = 'Transaksi Gagal';
                document.getElementById('receiptStatus').textContent = 'GAGAL';
                document.getElementById('receiptTrxId').textContent = response.message || 'Error';
            }
            
            receiptModal.style.display = 'block';

            beliButton.textContent = 'Beli Sekarang';
            beliButton.disabled = false;
            currentDepositId = null; 
        }

        // --- Tambahkan event listener untuk tutup modal konfirmasi saat klik di luar ---
        window.addEventListener('click', (event) => {
            if (event.target == confirmModal) {
                confirmModal.style.display = 'none';
                beliButton.textContent = 'Beli Sekarang';
                beliButton.disabled = false;
            }
            // ... existing window click events ...
        });

        // Kode JavaScript yang sudah ada tetap di bawah ini...
        // ... (semua kode JavaScript yang sudah ada)

    </script>
</body>
</html>
